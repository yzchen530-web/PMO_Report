<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å®¢æœæ¥è½é‡åˆ†æå·¥å…·</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 30px; background-color: #f4f7f6; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); max-width: 1000px; margin: auto; }
        .upload-area { border: 2px dashed #2ecc71; padding: 25px; text-align: center; border-radius: 10px; background: #fbfffc; cursor: pointer; }
        .btn { background: #2ecc71; color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; display: inline-block; }
        #chart { width: 100%; height: 600px; margin-top: 20px; }
        .info { font-size: 14px; color: #666; margin-top: 10px; line-height: 1.6; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ“ å®¢æœå€‹åˆ¥æ¥è½é‡ - å¹´åº¦ç†±é»åˆ†æ</h1>
    <div class="info">
        ğŸ’¡ <b>ä½¿ç”¨èªªæ˜ï¼š</b> æ­¤å·¥å…·å›ºå®šè®€å– Excel æª”æ¡ˆçš„ <b>ç¬¬ 2 å€‹åˆ†é </b>ã€‚<br>
        è«‹ç¢ºèªæ¨™é¡ŒåŒ…å«ï¼š<strong>æ—¥æœŸã€äººå“¡ã€å€‹åˆ¥æ¥è½é‡</strong>
    </div>
    <br>
    <div class="upload-area" onclick="document.getElementById('excel-file').click()">
        <span class="btn">é¸æ“‡ Excel æª”æ¡ˆ</span>
        <input type="file" id="excel-file" accept=".xlsx, .xls">
        <div id="status" style="margin-top:10px;">å°šæœªä¸Šå‚³æª”æ¡ˆ</div>
    </div>

    <div id="chart"></div>
</div>

<script>
    document.getElementById('excel-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        document.getElementById('status').innerText = `è®€å–ä¸­ï¼š${file.name}`;
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            
            // --- åªè®€å–ç¬¬äºŒå¼µå·¥ä½œè¡¨ ---
            const secondSheetName = workbook.SheetNames[1]; 
            if (!secondSheetName) {
                alert("éŒ¯èª¤ï¼šé€™ä»½æª”æ¡ˆä¼¼ä¹æ²’æœ‰ç¬¬äºŒå¼µå·¥ä½œè¡¨ï¼");
                return;
            }
            
            const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[secondSheetName]);
            
            // è³‡æ–™è½‰æ›èˆ‡æ¸…æ´—
            const processedData = rawData.map(row => {
                let d = row['æ—¥æœŸ'];
                let monthLabel = "æœªçŸ¥";
                
                if (d instanceof Date) {
                    monthLabel = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                }
                
                return {
                    month: monthLabel,
                    name: row['äººå“¡'],
                    value: parseInt(row['å€‹åˆ¥æ¥è½é‡']) || 0
                };
            }).filter(d => d.month !== "æœªçŸ¥" && d.name);

            drawHeatmap(processedData);
        };
        reader.readAsArrayBuffer(file);
    });

    function drawHeatmap(data) {
        const months = [...new Set(data.map(d => d.month))].sort();
        const names = [...new Set(data.map(d => d.name))];
        
        const zValues = names.map(name => {
            return months.map(month => {
                return data.filter(d => d.name === name && d.month === month)
                           .reduce((sum, curr) => sum + curr.value, 0);
            });
        });

        const trace = {
            z: zValues,
            x: months,
            y: names,
            type: 'heatmap',
            colorscale: 'Portland', 
            colorbar: { title: 'æ¥è½é‡' }
        };

        const layout = {
            title: 'å®¢æœäººå“¡æ¯æœˆæ¥è½é‡åˆ†ä½ˆ',
            xaxis: { title: 'æœˆä»½' },
            yaxis: { title: 'å®¢æœäººå“¡', autorange: 'reversed' },
            margin: { l: 120 }
        };

        Plotly.newPlot('chart', [trace], layout, {responsive: true});
        document.getElementById('status').innerText = "âœ… åˆ†æå®Œç•¢ï¼";
    }
</script>

</body>
</html>