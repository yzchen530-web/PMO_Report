<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æœä¸­å¿ƒæœå‹™é‡ç¸¾æ•ˆåˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #ecf0f1;
            --accent-color: #0E438A;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-bg);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            box-sizing: border-box;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-main);
        }

        .column-title {
            font-size: 1.65em;
            font-weight: 900; 
            color: #0E438A; 
            margin: 0 0 15px 0;
            padding: 10px 15px;
            border-left: 8px solid #D83A2C; 
            border-bottom: 3px solid #c8d6e5;
            background-color: rgba(14, 67, 138, 0.04); 
            border-radius: 6px 6px 0 0;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .upload-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: background 0.3s, transform 0.1s;
        }

        .upload-btn:hover { background-color: #0b346e;
        }
        .upload-btn:active { transform: scale(0.98);
        }

        .sheet-selector {
            padding: 9px 15px;
            border-radius: 8px;
            border: 2px solid var(--accent-color);
            font-size: 0.95em;
            font-weight: bold;
            color: var(--accent-color);
            background-color: #fff;
            cursor: pointer;
            outline: none;
            min-width: 180px;
        }

        .sheet-selector:disabled {
            border-color: #bdc3c7;
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        .dashboard {
            display: grid;
            /* ä½¿ç”¨ minmax(0, Xfr) å¯ä»¥é˜²æ­¢å…§éƒ¨åœ–è¡¨æŠŠæ¬„ä½ç•°å¸¸æ’å¤§ï¼Œå¼·åˆ¶é–æ­» 1:2:1 æ¯”ä¾‹ */
            grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr);
            gap: 20px;
            height: calc(100vh - 120px);
            min-height: 800px;
        }

        .col { display: flex;
            flex-direction: column; gap: 15px; height: 100%; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .center-col {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .card-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-main);
            border-bottom: 2px solid #ccc;
            padding-bottom: 8px;
        }

        p { margin: 0 0 8px 0; line-height: 1.5; font-size: 0.95em;
        }
        .chart-container { flex: 1; width: 100%; min-height: 160px;
        }
        #heatmap { flex: 1; width: 100%; min-height: 500px;
        }
        .highlight { color: #D83A2C; font-weight: bold; font-size: 1.2em;
        }
        .badge { color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em;
            display: inline-block; margin-bottom: 5px; }
        .insight-text { font-size: 0.85em; color: var(--text-light); margin-top: auto;
            padding-top: 10px; border-top: 1px dashed #ccc; }

        @media (max-width: 1200px) {
            .dashboard { grid-template-columns: 1fr;
                height: auto; }
            #heatmap { min-height: 600px;
            }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="header-title">ğŸ“ å®¢æœä¸­å¿ƒæœå‹™é‡ç¸¾æ•ˆåˆ†æ</div>
        <div class="upload-area">
            <label for="excelFileInput" class="upload-btn">ğŸ“‚ ä¸Šå‚³ Excel/CSV</label>
            <input type="file" id="excelFileInput" accept=".xlsx, .xls, .csv" style="display: none;">
            <select id="sheetSelector" class="sheet-selector" disabled>
              
                <option value="">è«‹å…ˆä¸Šå‚³æª”æ¡ˆ...</option>
            </select>
            <span id="fileName" style="font-size: 0.9em; color: var(--text-light); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
        </div>
    </div>

    <div class="dashboard">
        <div class="col">
            <div class="column-title">æ ¸å¿ƒæ¥è½åˆ†å¸ƒèˆ‡äººå“¡è¡¨ç¾</div>
            <div class="card" style="flex: 0.8;">
    <div class="card-header">ğŸ“Š æ•¸æ“šæº«åº¦è¨ˆï¼šç†±åŠ›åœ–èªªæ˜</div>
    <p style="margin-bottom: 5px;"><b>ç†±åŠ›åœ–</b> å°±åƒæ•¸æ“šæº«åº¦è¨ˆï¼Œæ”¹ç”¨ã€Œé¡è‰²ã€ä¸€çœ¼ç§’æ‡‚æ¥è½è² è¼‰ï¼š</p>
    <p style="margin: 5px 0 10px 0; font-size: 0.9em;">ğŸ§Š <b>æ·±è—(æ¥µä½)</b> â†’ ğŸŸ¢ <b>é»ƒç¶ (ä¸­)</b> â†’ ğŸ”¥ <b>ç£šç´…(æ¥µé«˜)</b></p>
    <p class="insight-text" style="margin-top: 5px;">ğŸ’¡X è»¸ <b style="color:#D83A2C;">ç´…å­—</b> ç‚ºå‡æ—¥(åŒ…å«åœ‹å®šå‡æ—¥)ã€‚ç‚ºå‘ˆç¾çœŸå¯¦ç¯€å¥ï¼Œå…©å´è¶¨å‹¢åœ–å·²æ’é™¤å‡æ—¥æ•¸æ“šã€‚</p>
</div>
            <div class="card" style="flex: 1.5;">
                <div class="card-header">ğŸ† é«˜ç”¢å‡ºæ ¸å¿ƒäººå“¡</div>
                <p>æœ€ä½³è¡¨ç¾äººå“¡ï¼š<span class="highlight" id="topPersonName">-</span></p>
                <p>å…¨å€é–“ç´¯è¨ˆ(å«å‡æ—¥)ï¼š<b id="topPersonTotal" style="color:#2c3e50;">-</b></p>
            
                <div id="topPersonChart" class="chart-container"></div>
            </div>
            <div class="card" style="flex: 1.2;">
                <div class="card-header">âš–ï¸ äººåŠ›è³‡æºå·®ç•°åˆ†é…</div>
                <p style="margin-bottom: 0;">æ¥µç«¯è² è¼‰æ¯”è¼ƒ (æœ€é«˜ vs åœ˜éšŠå¹³å‡ vs æœ€ä½)ï¼š</p>
                <div id="resourceChart" class="chart-container" style="min-height: 140px;"></div>
      
                <p class="insight-text">âš ï¸é¦–å°¾ç”¢èƒ½è½å·®è‹¥éå¤§ï¼Œé¡¯ç¤ºå·¥ä½œåˆ†é…é›†ä¸­é¢¨éšªï¼Œéœ€é©æ™‚ä»‹å…¥è¼”å°æˆ–æ’ç­ã€‚</p>
            </div>
        </div>

        <div class="center-col">
            <h3 style="text-align: center; margin: 0 0 10px 0; color: #34495e;">
                äººå“¡æ¥è½é‡ç†±åŠ›åœ–åˆ†ä½ˆ <span id="timeUnitTitle" style="font-size: 0.85em; color:#D83A2C;"></span>
            </h3>
            <div id="heatmap"></div>
        </div>

        <div class="col">
            <div class="column-title">è¶¨å‹¢èˆ‡æˆé•·å‹•å‘</div>
            <div class="card" style="flex: 1.2;">
                <div class="card-header">ğŸ‘¥ äººåŠ›å‹•å“¡è¶¨å‹¢</div>
            
                <p style="margin-bottom: 0;">å¯¦éš›ä¸Šç·š(æœ‰æ¥è½)äººæ•¸å¹³æ»‘æ›²ç·šï¼š</p>
                <div id="activePersonChart" class="chart-container" style="min-height: 140px;"></div>
            </div>
            <div class="card" style="flex: 1.4;">
                <div class="card-header">ğŸ“ˆ æ¥è½é«˜å³°åˆ†æ</div>
                <p>å…¨å€é–“æœ€é«˜å³°æ™‚é–“(å«å‡æ—¥)ï¼š<span class="highlight" id="peakTimeName">-</span></p>
           
                <p>è©²æ™‚æ®µæ¥è½ç¸½é‡ï¼š<b id="peakTimeTotal" style="color:#2c3e50;">-</b></p>
                <div id="peakTimeChart" class="chart-container"></div>
            </div>
            <div class="card" style="flex: 0.8;">
                <div class="card-header">ğŸ–ï¸ äººå“¡è¡¨ç¾åˆ†ç´šæ‘˜è¦</div>
                <div id="gradesContainer" style="overflow-y: auto; font-size: 0.92em; color: #95a5a6;">ç­‰å¾…è³‡æ–™è¼‰å…¥...</div>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // â˜… ä¸­è¯æ°‘åœ‹ 2025 åŠ 2026 å¹´åœ‹å®šå‡æ—¥èˆ‡è£œç­æ—¥è¨­å®šè¡¨ â˜…
        // =========================================================================
        const TAIWAN_HOLIDAYS = [
            // --- 2025 å¹´ ---
            "2025-01-01", // å…ƒæ—¦
            "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31", // æ˜¥ç¯€é€£å‡ (å«å°å¹´å¤œã€é™¤å¤•)
            "2025-02-28", // å’Œå¹³ç´€å¿µæ—¥
            "2025-04-03", "2025-04-04", // å…’ç«¥ç¯€ã€æ¸…æ˜ç¯€ (4/3ææ—©æ”¾)
            "2025-05-01", // å‹å‹•ç¯€
            "2025-05-30", // ç«¯åˆç¯€
            "2025-09-29", // æ•™å¸«ç¯€è£œå‡
            "2025-10-06", // ä¸­ç§‹ç¯€
            "2025-10-10", // åœ‹æ…¶æ—¥
            "2025-10-24", // å…‰å¾©ç¯€è£œå‡
            "2025-12-25", // è¡Œæ†²ç´€å¿µæ—¥
            
            // --- 2026 å¹´ ---
            "2026-01-01", // å…ƒæ—¦
            "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20", // æ˜¥ç¯€é€£å‡ (å«é™¤å¤•åŠå°å¹´å¤œè£œå‡)
            "2026-02-27", // 228 è£œå‡
            "2026-04-03", "2026-04-06", // å…’ç«¥ç¯€è£œå‡ã€æ¸…æ˜ç¯€è£œå‡
            "2026-05-01", // å‹å‹•ç¯€
            "2026-06-19", // ç«¯åˆç¯€
            "2026-09-25", // ä¸­ç§‹ç¯€
            "2026-09-28", // æ•™å¸«ç¯€
            "2026-10-09", // åœ‹æ…¶è£œå‡
            "2026-10-26", // å…‰å¾©ç¯€è£œå‡
            "2026-12-25"  // è¡Œæ†²ç´€å¿µæ—¥
        ];
        
        // è£œç­æ—¥ (éœ€è¦–ç‚ºå¹³æ—¥ï¼Œåœ–è¡¨ä¸å‰”é™¤ä¸”é¡¯ç¤ºé»‘å­—)
        const TAIWAN_MAKEUP_WORKDAYS = [
            "2025-02-08" // 2025 æ˜¥ç¯€è£œç­
        ];
        
        const myChart = echarts.init(document.getElementById('heatmap'));
        const topChart = echarts.init(document.getElementById('topPersonChart'));
        const resourceChart = echarts.init(document.getElementById('resourceChart'));
        const activeChart = echarts.init(document.getElementById('activePersonChart'));
        const peakChart = echarts.init(document.getElementById('peakTimeChart'));
        const colorScale = ['#0E438A', '#48989B', '#F6D746', '#EF9D3F', '#D83A2C'];

        const emptyOption = { title: { text: 'è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¸Šå‚³ Excel/CSV è³‡æ–™æª”', left: 'center', top: 'center', textStyle: { color: '#bdc3c7', fontSize: 16, fontWeight: 'normal' } } };
        myChart.setOption(emptyOption); topChart.setOption(emptyOption); resourceChart.setOption(emptyOption);
        activeChart.setOption(emptyOption); peakChart.setOption(emptyOption);

        let currentWorkbook = null;
        let csvParsedData = null; 
        let isCurrentFileCsv = false;
        
        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileName').innerText = file.name;
            e.target.value = ''; 
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            const sheetSelector = document.getElementById('sheetSelector');

            if (fileExt === 'csv') {
                isCurrentFileCsv = true;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    Papa.parse(evt.target.result, {
                        header: true, skipEmptyLines: true,
                        complete: function(results) {
                            csvParsedData = results.data;
                            sheetSelector.innerHTML = '<option value="csv_default">ğŸ“‹ é è¨­é ç±¤ (CSV)</option>';
                            sheetSelector.disabled = false;
                            analyzeData('csv_default'); 
                        }
                    });
                };
                reader.readAsText(file); 
            } else {
                isCurrentFileCsv = false;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        currentWorkbook = XLSX.read(data, {type: 'array', cellDates: true});
                        sheetSelector.innerHTML = '';
                        if (currentWorkbook.SheetNames.length === 0) throw new Error("ç„¡é ç±¤");
                        currentWorkbook.SheetNames.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = `ğŸ“‹ é ç±¤ï¼š${name}`;
                            sheetSelector.appendChild(opt);
                        });
                        sheetSelector.disabled = false;
                        analyzeData(currentWorkbook.SheetNames[0]);
                    } catch (error) {
                        console.error(error);
                        alert("Excel è§£æç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        document.getElementById('sheetSelector').addEventListener('change', function(e) {
            analyzeData(e.target.value);
        });
        
        function analyzeData(sheetName) {
            let data = [];
            if (isCurrentFileCsv) {
                data = csvParsedData;
            } else {
                const worksheet = currentWorkbook.Sheets[sheetName];
                data = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
            }
            
            if(!data || data.length === 0) {
                alert(`è³‡æ–™è®€å–å¤±æ•—æˆ–å…§å®¹ç‚ºç©ºï¼`);
                return;
            }

            let rawParsedData = [];
            let uniqueMonths = new Set();

            data.forEach(row => {
                let dateStr = row['æ—¥æœŸ'] || row['date'] || row['Date'] || row[Object.keys(row)[0]];
                let person = row['äººå“¡'] || row['person'] || row['Person'] || row[Object.keys(row)[1]];
                let valStr = row['å€‹åˆ¥æ¥è½é‡'] || row['æ¥è½é‡'] || row['calls'] || row[Object.keys(row)[2]];
                
                if(!dateStr || !person || valStr == null) return;
                
                let dateObj = new Date(dateStr);
                if (isNaN(dateObj.getTime())) return;
                
                let val = parseInt(valStr, 10);
                if (isNaN(val)) return;

                let monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                let dateKey = `${monthKey}-${String(dateObj.getDate()).padStart(2, '0')}`;
                
                uniqueMonths.add(monthKey);
                rawParsedData.push({ monthKey, dateKey, person, val });
            });
            
            if(rawParsedData.length === 0) {
                alert('ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹ç¢ºèªç¬¬ä¸€åˆ—çš„æ¬„ä½åç¨±æ˜¯å¦æœ‰ã€Œæ—¥æœŸã€ã€ã€Œäººå“¡ã€ã€ã€Œå€‹åˆ¥æ¥è½é‡ã€');
                return;
            }

            let isYearly = true;
            if (sheetName.includes('æœˆ') && !sheetName.includes('å¹´')) {
                isYearly = false;
            } else if (sheetName.includes('å¹´')) {
                isYearly = true;
            } else {
                isYearly = uniqueMonths.size > 1;
            }

            let heatmapMap = {}; let personSum = {};
            let timeSum = {};
            let timePersons = {}; let timeKeysSet = new Set(); let personsSet = new Set();
            
            rawParsedData.forEach(d => {
                let timeKey = isYearly ? d.monthKey : d.dateKey;
                timeKeysSet.add(timeKey);
                personsSet.add(d.person);

                let mapKey = `${timeKey}_${d.person}`;
                heatmapMap[mapKey] = (heatmapMap[mapKey] || 0) + d.val;
                personSum[d.person] = (personSum[d.person] || 0) + d.val;
                timeSum[timeKey] = (timeSum[timeKey] || 0) + d.val;
                
                if (!timePersons[timeKey]) timePersons[timeKey] = new Set();
                timePersons[timeKey].add(d.person);
            });

            const timeLabels = Array.from(timeKeysSet).sort();
            const persons = Array.from(personsSet).sort();
            
            let heatmapData = [];
            timeLabels.forEach((t, tIdx) => {
                persons.forEach((p, pIdx) => {
                    let val = heatmapMap[`${t}_${p}`] || 0; 
                    heatmapData.push([tIdx, pIdx, val]);
                });
            });
            
            let sortedPersons = Object.keys(personSum).map(p => ({person: p, sum: personSum[p]})).sort((a,b) => b.sum - a.sum);
            let topPerson = sortedPersons[0].person;
            let topPersonTotal = sortedPersons[0].sum;
            let minPerson = sortedPersons[sortedPersons.length-1].person; let minPersonTotal = sortedPersons[sortedPersons.length-1].sum;
            let meanTotal = sortedPersons.reduce((acc, curr) => acc + curr.sum, 0) / sortedPersons.length;
            let sortedTimes = Object.keys(timeSum).map(t => ({time: t, sum: timeSum[t]})).sort((a,b) => b.sum - a.sum);
            let peakTime = sortedTimes[0].time;
            let peakTimeTotal = sortedTimes[0].sum;
            
            let topPersonTimeline = timeLabels.map(t => heatmapMap[`${t}_${topPerson}`] || 0);
            let allTimesTotal = timeLabels.map(t => timeSum[t] || 0);
            let activePersonsList = timeLabels.map(t => ({time: t, count: timePersons[t].size}));

            let gradeThresholdA = Math.round(meanTotal * 1.2);
            let gradeThresholdB = Math.round(meanTotal * 0.8);
            
            let grades = { A: [], B: [], C: [] };
            sortedPersons.forEach(p => {
                if(p.sum >= gradeThresholdA) grades.A.push(p.person);
                else if(p.sum >= gradeThresholdB) grades.B.push(p.person);
                else grades.C.push(p.person);
            });
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºå‡æ—¥ (å…­æ—¥ + åœ‹å®šå‡æ—¥ - è£œç­æ—¥)
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let isHolidayList = [];
            let displayTimeLabels = [];
            let tooltipFullLabels = [];
            // çµ¦ Tooltip çœ‹çš„å®Œæ•´æ—¥æœŸ

            timeLabels.forEach(t => {
                if (isYearly) {
                    isHolidayList.push(false);
                    displayTimeLabels.push(t);
                    tooltipFullLabels.push(t);
                } else {
                    let d = new Date(t);
                    let day = d.getDay();
                    let isWeekend = (day === 0 || day === 6);
                    let isNational = TAIWAN_HOLIDAYS.includes(t);
                    let isMakeup = TAIWAN_MAKEUP_WORKDAYS.includes(t);
                    
                    // å‡æ—¥åˆ¤å®šï¼š(é€±æœ«ä¸”éè£œç­) æˆ–æ˜¯ åœ‹å®šæ”¾å‡æ—¥
                    isHolidayList.push((isWeekend && !isMakeup) || isNational);

                    // X è»¸åƒ…ä¿ç•™ DD è·Ÿæ˜ŸæœŸå¹¾
                    let dd = String(d.getDate()).padStart(2, '0');
                    let dw = dayNames[day];
                    displayTimeLabels.push(`${dd}\n(${dw})`);
                    tooltipFullLabels.push(`${t} (${dw})`);
                }
            });
            
            // å–å¾—å–®æœˆçš„å¹´æœˆä»½å­—ä¸²ï¼Œç”¨ä¾†æ”¾é€²æ¨™é¡Œ
            let singleMonthLabel = "";
            if (!isYearly) {
                let firstMonth = Array.from(uniqueMonths)[0];
                // ä¾‹: "2026-02"
                let parts = firstMonth.split('-');
                singleMonthLabel = `${parts[0]}å¹´${parts[1]}æœˆ`;
            }

            updateUI({ 
                isYearly, timeLabels, displayTimeLabels, tooltipFullLabels, isHolidayList, singleMonthLabel,
                persons, heatmapData, topPerson, topPersonTotal, topPersonTimeline, 
                minPerson, minPersonTotal, meanTotal, peakTime, peakTimeTotal, allTimesTotal, 
                activePersonsList, grades, thresholds: { A: gradeThresholdA, B: gradeThresholdB }
            });
        }

        function updateUI(parsed) {
            myChart.clear();
            topChart.clear(); resourceChart.clear(); activeChart.clear(); peakChart.clear();

            // è¨­å®šæ¨™é¡Œ (å–®æœˆæœƒé¡¯ç¤º å¹´æœˆ)
            document.getElementById('timeUnitTitle').innerText = parsed.isYearly ? '(ä¾æœˆä»½åˆ†æ)' : `(${parsed.singleMonthLabel})`;

            // ç¸½è¨ˆä¸è®Š (ä»ç„¶åŒ…å«å‡æ—¥)
            document.getElementById('topPersonName').innerText = parsed.topPerson;
            document.getElementById('topPersonTotal').innerText = parsed.topPersonTotal.toLocaleString() + ' é€š';
            
            let peakTimeIdx = parsed.timeLabels.indexOf(parsed.peakTime);
            document.getElementById('peakTimeName').innerText = parsed.tooltipFullLabels[peakTimeIdx];
            document.getElementById('peakTimeTotal').innerText = parsed.peakTimeTotal.toLocaleString() + ' é€š';
            
            // åŠ å…¥ new Option(å­—ä¸²).innerHTML é˜²ç¦¦ XSS æ”»æ“Š
            document.getElementById('gradesContainer').innerHTML = `
                <div style="margin-bottom: 12px;"><span class="badge A" style="background-color: #D83A2C;">Aç´š (é«˜æ–¼å¹³å‡20%: &ge; ${parsed.thresholds.A}é€š)</span><p style="margin: 3px 0 0 5px; font-weight: bold; color: #2c3e50;">${new Option(parsed.grades.A.join(', ') || 'ç„¡').innerHTML}</p></div>
                <div style="margin-bottom: 12px;"><span class="badge B" style="background-color: #EF9D3F;">Bç´š (å¹³å‡å€é–“: ${parsed.thresholds.B}~${parsed.thresholds.A}é€š)</span><p style="margin: 3px 0 0 5px; font-weight: bold; color: #2c3e50;">${new Option(parsed.grades.B.join(', ') || 'ç„¡').innerHTML}</p></div>
                <div><span class="badge C" style="background-color: #48989B;">Cç´š (ä½æ–¼å¹³å‡20%: &lt; ${parsed.thresholds.B}é€š)</span><p style="margin: 3px 0 0 5px; font-weight: bold; color: #2c3e50;">${new Option(parsed.grades.C.join(', ') || 'ç„¡').innerHTML}</p></div>
            `;

            let maxVal = Math.max(...parsed.heatmapData.map(d => d[2]));
            if(!isFinite(maxVal) || maxVal === 0) maxVal = 1000;

            // 1. ç†±åŠ›åœ– (å®Œæ•´é¡¯ç¤ºæ¯ä¸€å¤©ï¼ŒXè»¸è¦‹ç´…ä¼‘å­—é«”è®Šç´…)
            myChart.setOption({
                tooltip: {
                    position: 'top',
                    formatter: function (p) {
                        return `<b>${parsed.tooltipFullLabels[p.value[0]]}</b><br/>äººå“¡: ${parsed.persons[p.value[1]]}<br/>æ¥è½é‡: <b style="color:#D83A2C;">${p.value[2]}</b> é€š`;
                    }
                },
                grid: { top: '5%', right: '5%', left: '15%', bottom: '20%' },
                xAxis: { 
                    type: 'category', 
                    data: parsed.displayTimeLabels, 
                    splitArea: { show: true }, 
                    axisLabel: { 
                        interval: 0, 
                        // åˆ©ç”¨ index æ‰¾å‡ºæ˜¯å¦ç‚ºå‡æ—¥
                        color: function(value, index) { return parsed.isHolidayList[index] ? '#D83A2C' : '#333'; }
                    } 
                },
                yAxis: { type: 'category', data: parsed.persons, splitArea: { show: true }, name: 'äººå“¡' },
                visualMap: {
                    min: 0, max: maxVal, calculable: true, orient: 'horizontal',
                    left: 'center', bottom: '1%', text: ['æ¥µé«˜', 'æ¥µä½'], inRange: { color: colorScale }
                },
                series: [{
                    type: 'heatmap', 
                    data: parsed.heatmapData,
                    label: { 
                        show: true, 
                        formatter: function(params) {
                            let val = params.value[2];
                            if (val < maxVal * 0.20 || val > maxVal * 0.80) return '{white|' + val + '}';
                            else return '{black|' + val + '}';
                        },
                        rich: { white: { color: '#ffffff', fontSize: 11, fontWeight: 'bold' }, black: { color: '#000000', fontSize: 11, fontWeight: 'bold' } }
                    },
                    itemStyle: { borderColor: '#fff', borderWidth: 1 }
                }]
            });
            
            // ç”¢ç”Ÿå°ˆå±¬ã€Œå¹³æ—¥ã€çš„åœ–è¡¨æ•¸æ“šé™£åˆ— (è‹¥å–®æœˆåˆ†æï¼Œéæ¿¾æ‰å‡æ—¥)
            let chartLabels = [];
            let chartTopPersonData = [];
            let chartActiveData = [];
            let chartPeakData = [];
            
            parsed.displayTimeLabels.forEach((label, i) => {
                // å¦‚æœæ˜¯å–®æœˆåˆ†æï¼Œä¸”é‡åˆ°å‡æ—¥ï¼Œå‰‡ç›´æ¥è·³éä¸ç•«
                if (!parsed.isYearly && parsed.isHolidayList[i]) return; 

                // å°‡ \n æ›æˆç©ºç™½ä»¥é©æ‡‰æ›²ç·šåœ–çš„ X è»¸
                chartLabels.push(label.replace('\n', '')); 
                chartTopPersonData.push(parsed.topPersonTimeline[i]);
                chartActiveData.push(parsed.activePersonsList[i].count);
                chartPeakData.push(parsed.allTimesTotal[i]);
            });
            
            // 2. é«˜ç”¢å‡ºæ ¸å¿ƒäººå“¡ (å¹³æ—¥å¹³æ»‘æ›²ç·šåœ–)
            topChart.setOption({
                tooltip: { trigger: 'axis' }, grid: { top: 15, right: 15, left: 45, bottom: 45 },
                xAxis: { type: 'category', data: chartLabels, axisLabel: { show: true, interval: 'auto', fontSize: 10, color: '#333' } }, 
                yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
                series: [{ 
                    data: chartTopPersonData, type: 'line', smooth: true, 
                    itemStyle: { color: '#D83A2C' },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(216,58,44,0.4)' }, { offset: 1, color: 'rgba(216,58,44,0.05)' }]) }
                }]
            });
            
            // 3. äººåŠ›è³‡æºå·®ç•°åœ–
            resourceChart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } }, grid: { top: 10, right: 120, left: 70, bottom: 20 },
                xAxis: { type: 'value', splitLine: { show: false }, show: false }, 
                yAxis: { type: 'category', data: ['æœ€ä½ç”¢å‡º', 'åœ˜éšŠå¹³å‡', 'æœ€é«˜ç”¢å‡º'], axisLine: {show: false}, axisTick: {show: false} },
                series: [{ type: 'bar', data: [{ value: parsed.minPersonTotal, name: parsed.minPerson, itemStyle: { color: '#0E438A', borderRadius: [0, 5, 5, 0] } }, { value: Math.round(parsed.meanTotal), name: 'å¹³å‡å€¼', itemStyle: { color: '#F6D746', borderRadius: [0, 5, 5, 0] } }, { value: parsed.topPersonTotal, name: parsed.topPerson, itemStyle: { color: '#D83A2C', borderRadius: [0, 5, 5, 0] } }], label: { show: true, position: 'right', formatter: function(p) { return p.data.name + ' (' + p.value + 'é€š)'; }, fontSize: 11, color: '#333' } }]
            });
            
            // 4. äººåŠ›å‹•å“¡è¶¨å‹¢ (å¹³æ—¥å¹³æ»‘æ›²ç·šåœ–)
            activeChart.setOption({
                tooltip: { trigger: 'axis' }, grid: { top: 25, right: 15, left: 35, bottom: 45 },
                xAxis: { type: 'category', data: chartLabels, axisLabel: { show: true, interval: 'auto', fontSize: 10, color: '#333' } }, 
                yAxis: { type: 'value', min: 0, splitLine: { lineStyle: { type: 'dashed' } }, minInterval: 1 },
                series: [{ 
                    data: chartActiveData, type: 'line', smooth: true, 
                    itemStyle: { color: '#48989B' }, 
                    areaStyle: { color: 'rgba(72, 152, 155, 0.15)' },
                    label: { show: true, position: 'top', formatter: '{c} äºº', fontSize: 10 } 
                }]
            });
            
            // 5. æ¥è½é«˜å³°åˆ†æåœ– (å¹³æ—¥å¹³æ»‘æ›²ç·šåœ– + æœ€é«˜å³°æ°´æ»´æ¨™ç±¤)
            peakChart.setOption({
                tooltip: { trigger: 'axis' }, grid: { top: 20, right: 15, left: 45, bottom: 45 },
                xAxis: { type: 'category', data: chartLabels, axisLabel: { show: true, interval: 'auto', fontSize: 10, color: '#333' } }, 
                yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
                series: [{ 
                    data: chartPeakData, type: 'line', smooth: true, 
                    itemStyle: { color: '#D83A2C' }, 
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(216,58,44,0.4)' }, { offset: 1, color: 'rgba(216,58,44,0.05)' }]) },
                    markPoint: {
                        data: [{ type: 'max', name: 'æœ€é«˜å³°' }],
                        itemStyle: { color: '#0E438A' },
                        label: { color: '#fff', fontSize: 10 }
                    }
                }]
            });
        }

        window.addEventListener('resize', function() {
            myChart.resize(); topChart.resize(); resourceChart.resize(); activeChart.resize(); peakChart.resize();
        });
    </script>
</body>
</html>